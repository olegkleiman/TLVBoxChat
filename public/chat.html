<!DOCTYPE html> 
<html> 
  
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8" />
    <title>עוזרת אישית - עיריית ת"א</title>
    <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://www.tel-aviv.gov.il/_layouts/15/TlvSP2013PublicSite/Images/IriaFavIcon.ico" />
    <style>
        df-messenger {
          z-index: 999;
          position: fixed;
          /* --df-messenger-button-titlebar-color: #df9b56; */
          --df-messenger-button-titlebar-color: #0a2f79;
          --df-messenger-font-color: #000;
          --df-messenger-font-family: Google Sans;
          --df-messenger-font-size: 14px;
          --df-messenger-chat-background: #f3f6fc;
          --df-messenger-message-user-background: #d3e3fd;
          --df-messenger-message-bot-background: #ecf3fe; 
          --df-messenger-input-background: white;
          --df-messenger-chips-text-wrap: "nowrap"
          bottom: 16px;
          right: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">    
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
    <!-- <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script> -->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> 
    <script src="https://unpkg.com/jwt-decode@2.0.4/build/jwt-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/arikw/itm-to-wgs84-converter@1/src/index.js"></script>
</head> 
  
<body> 
    <div>Version 24.10.2024 - Omon Ra</div>
    <div hidden id="jwt">ey..</div>
    <div id="count">0</div>
    <div id="location">xx,yy</div>
    <button class="mdc-button mdc-button--raised"
            onClick="expire()">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__touch"></span>
        <span class="mdc-button__label">Force Access Token Expiration</span>
    </button>
    <div id="expirationTime"></div>
    <button class="mdc-button mdc-button--raised"
            onClick="newSession()">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">New Session</span>
    </button>
    <!-- <div>
        <video id="vid"></video>
    </div> -->

    <div>
        <!-- Using intent='' You can use an event handler that will be called for this event and will produce the first agent message. -->
        <!-- session-id	Optional	A session ID. If this is not supplied, the integration will generate a unique ID for each chat dialog. -->
        <df-messenger
            project-id="muni-tlv"
            agent-id="46727f85-4983-4edb-b8b1-55df166837da"
            language-code="he-il"
            max-query-length="-1"
            storage-option="none"
            df-cx="true"
            intent="'WELCOME" 
            chat-icon="https://img.freepik.com/premium-vector/chat-logo-with-robot-face_1124-277.jpg"
            chat-title-icon="https://img.freepik.com/premium-vector/chat-logo-with-robot-face_1124-277.jpg"
            allow-feedback="all">
            <df-messenger-chat-bubble
                expanded="true"
                chat-title="TLV Box"
                chat-subtitle="עוזרת אישית"
                enable-file-upload
                allow-fullscreen="always">
            </df-messenger-chat-bubble>
        </df-messenger>
        <button id="record" style="z-index: 1000;position: absolute; bottom: -723px; right: 60px;padding: 0;border:none;background: none;">
        <!-- <button id="record" style="z-index: 1000;position: absolute; top: 685px; right: 60px;padding: 0;border:none;background: none;"></button> -->
            <img alt="Start" id="mic_img" style="border:none;" width="32" height="32" src="https://www.google.com/intl/en/chrome/assets/common/images/content/mic.gif" />
        </button>
    </div>

    <!-- <script>
        setTimeout(function(){ 
            document.querySelector("df-messenger")
                .querySelector("df-messenger-chat-bubble")
                .querySelector("df-messenger-user-input")
                .shadowRoot.querySelector(".input-box-wrapper > input")
                .placeholder="New placeholder text" }, 1000);
    </script> -->

    <script>

        const accessTokenDiv = document.getElementById('jwt');
        const locationDiv = document.getElementById('location');
        const dfMessenger = document.querySelector('df-messenger');
        const micButton = document.getElementById('record');
        const micImage = document.getElementById('mic_img');
        var currentVoice;
        const countDiv = document.getElementById("count");

        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'he-IL';
        recognition.continuous = false; // when the user stops talking, speech recognition will end.
        recognition.interimResults = false; // only results returned by the recognizer are final and will not change. 
        recognition.onspeechend = () => {
            recognition.stop();
        };      
        recognition.onnomatch = (event) => {
            transcriptElement.innerText = "I didn't recognize your speech.";
        }; 
        recognition.onerror = (event) => {
            console.error(`Error occurred while transcribing audio: ${event.error}`);
        }
        recognition.onresult = (event) => {
            stopRecording();

            const transcript = event.results[0][0].transcript;

            dfMessenger.sendQuery(transcript, false);

            let utterance = new SpeechSynthesisUtterance(transcript);
            window.speechSynthesis.onvoiceschanged = () => {
                var voices = window.speechSynthesis.getVoices();
                currentVoice = voices[0];
                utterance.voice = voices[0];
                utterance.pitch = 1
                utterance.rate = 0.5
                speechSynthesis.speak(utterance)
            };
            utterance.onend = function (event) {
                console.log("SpeechSynthesisUtterance.onend");
            };
            utterance.onerror = function (event) {
                console.error("SpeechSynthesisUtterance.onerror");
            };
            utterance.voice = currentVoice;
            speechSynthesis.speak(utterance)
        }

        const projectId = 'muni-tlv';
            const apiKey = 'AIzaSyA_rpSTA3xIzFcAK-9OSdF03Z9AK_0kogs';

            const startRecording = () => {
                micImage.alt = "Stop";
                micImage.src = "https://www.google.com/intl/en/chrome/assets/common/images/content/mic-animate.gif";
            
                recognition.start();
            }
            const stopRecording = () => {
                micImage.alt = "Start";
                micImage.src = "https://www.google.com/intl/en/chrome/assets/common/images/content/mic.gif";

                recognition.stop();
            }

        // When the record button is clicked, start recording audio
        document.getElementById('record').addEventListener('click', () => {
            
            if( micImage.alt == "Start" ) 
                startRecording();
            else
                stopRecording();

        })

        //alert("Loading")

        function receiveAccessToken(accessToken) {

            console.log("receiveAccessToken called")
            var token = jwt_decode(accessToken);

            var cnt = parseInt(countDiv.innerText, 10);
            console.log("Count: " + cnt)
            if( cnt == 0 ) {
                dfMessenger.renderCustomText('שלום' + token.name)
            }
            countDiv.textContent = cnt + 1;
            accessTokenDiv.innerText = accessToken;

            const expirationDiv = document.getElementById("expirationTime");
            var d = new Date(token.exp * 1000);
            expirationDiv.innerText = d.toLocaleString()
        }

        function expire() {

                webViewInterface = window.Native
                webViewInterface.refreshAccessToken();

        }

        function newSession()
        {
            dfMessenger.startNewSession({ retainHistory: true });
            location.reload()
        }

        function openCamera() {
            

            const mediaDevices = navigator.mediaDevices;
            if (!mediaDevices || !mediaDevices.getUserMedia) {
                alert("getUserMedia() not supported.");
                return;
            }

            mediaDevices.getUserMedia({video: true, 
                                        audio: false})
                        .then( (stream) => {
                            let video = document.getElementById("vid");
                            if ("srcObject" in video) {
                                video.srcObject = stream;
                            } else {
                                video.src = window.URL.createObjectURL(stream);
                            }
                            
                            video.addEventListener("loadedmetadata", () => {
                                video.play();
                            });
                        })
                        .catch(alert);

//                         Accessing the phone's front and rear cameras

// const constraints = {
//   video: {
//     width: { ... },
//     height: { ... },
//     facingMode: "environment"
//   },
// };

// videoStream.getTracks().forEach((track) => {
//   track.stop()
// })                        
            
// Taking screenshots

// // considering there is a
// // <canvas id="canvas"></canvas>
// // tag in the page
// const canvas = document.querySelector('#canvas')
// canvas.width = video.videoWidth
// canvas.height = video.videoHeight
// canvas.getContext('2d').drawImage(video, 0, 0)

// const img = document.createElement('img')
// img.src = canvas.toDataURL('image/png')
// screenshotsContainer.prepend(img)

        }

        function geoSuccess(position) {

                var location = `${position.coords.latitude},${position.coords.longitude}`

                // Comment these 3 lines for location-aware app
               const latitude = 32.081779
               const longitude = 34.780675
               location = `${latitude},${longitude}`

                console.log(location);
                
                locationDiv.innerText = location;
        }

        function geoError(error) {
                //console.error(error.message)
                alert(`Error: ${error.message}`)
        }

        if( !navigator.geolocation ) {
            alert('No geolocation available')
        } else {
            navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
            //console.log(`WatchId: ${watchID}`)
        }

        // window.addEventListener('df-messenger-loaded', function() {

        //     console.log('Messenger is ready.');

        //     const queryParams = {
        //         parameters:{
        //           "jwt": accessTokenDiv.innerText,
        //           "User_Authorized": "True",
        //           "userId": '313069486',
        //           }
        //       };

        //     //dfMessenger.setQueryParameters(queryParams)
        // });

        window.addEventListener('df-file-upload-completed', function (event) {
            // simulates an end-user input that is normally provided to the agent dialog
            // (May also be used to simulate events)
            dfMessenger.sendRequest('query','file uploaded');
        });

        window.addEventListener('df-session-id-set', function(event) {
            console.log('Session set');
        });

        dfMessenger.addEventListener('df-chat-open-changed', function(event) {
            console.log(`Chat is ${event.detail.isOpen ? 'open' : 'closed'}`);
            const sendButton = document.getElementById('send-icon-button');
        });
        window.addEventListener('df-messenger-error', function (event) {
            console.log(event.detail.error)
        });
        window.addEventListener('df-request-sent', (event) => {
            console.log('Request', event.detail.data.requestBody);
        });
        window.addEventListener('df-response-received', (event) => {
            console.log(event.detail)
        })
        window.addEventListener('df-chip-clicked', async (event) => {
            console.log(event)

            // if( event.detail.actionLink === "geo://" ) {
            //     const startPosition = event.detail.text.indexOf("[");
            //     const endPosition = event.detail.text.lastIndexOf("]")
            //     const _location = event.detail.text.substring(startPosition+1, endPosition);
            //     const parts = _location.split(",")

            //     const east = parseInt(parts[0], 10);
            //     const north = parseInt(parts[1], 10);

            //     const [ latitude, longitude ] = ItmToWgs84Converter.itm2wgs84(east, north); 
            //     alert(`${latitude}  ${longitude}`)
            //     launchMaps(latitude, longitude, event.detail.text)
            // }
            
        })
        window.addEventListener('df-user-input-entered', (event) => {
            console.log(event)

            const jwt = accessTokenDiv.innerText;

            try {
                const token = jwt_decode(jwt);

                const coordinates = locationDiv.innerText.split(",");
                const latitude = parseFloat(coordinates[0]);
                const longitude = parseFloat(coordinates[1]);

                const queryParams = {
                    parameters:{
                    "jwt": jwt,
                    "userEmail": token["signInNamesInfo.emailAddress"],
                    "userName": token.name,
                    "userId": token["signInNames.citizenId"],
                    "latitude": latitude,
                    "longitude" : longitude
                    }
                };

                dfMessenger.setQueryParameters(queryParams)     
            } catch(ex) {
                console.log(ex.message)
            }

        
        })
        
    </script>
</body> 
  
</html>  