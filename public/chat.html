<!DOCTYPE html> 
<html> 
  
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta charset="UTF-8" />
    <style>
        df-messenger {
          z-index: 999;
          position: fixed;
          /* --df-messenger-button-titlebar-color: #df9b56; */
          --df-messenger-button-titlebar-color: #0a2f79;
          --df-messenger-font-color: #000;
          --df-messenger-font-family: Google Sans;
          --df-messenger-font-size: 14px;
          --df-messenger-chat-background: #f3f6fc;
          --df-messenger-message-user-background: #d3e3fd;
          --df-messenger-message-bot-background: #ecf3fe; 
          --df-messenger-input-background: white;
          /* #fff; */
          bottom: 16px;
          right: 16px;
          
        }
    </style>
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">    
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
    <!-- <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script> -->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> 
    <script src="https://unpkg.com/jwt-decode@2.0.4/build/jwt-decode.min.js"></script>  
</head> 
  
<body> 
    <div hidden id="jwt">ey..</div>
    <div id="location">xx.yy</div>
    <button class="mdc-button mdc-button--raised"
            onClick="expire()">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__touch"></span>
        <span class="mdc-button__label">Force Access Token Expiration</span>
    </button>
    <div id="expirationTime"></div>
    <button class="mdc-button mdc-button--raised"
            onClick="openCamera()">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">Open Camera</span>
    </button>
    <div>
        <video id="vid"></video>
    </div>
    <df-messenger
        project-id="muni-tlv"
        agent-id="46727f85-4983-4edb-b8b1-55df166837da"
        language-code="he-il"
        max-query-length="-1"
        storage-option="none"
        chat-icon="https://img.freepik.com/premium-vector/chat-logo-with-robot-face_1124-277.jpg"
        chat-title-icon="https://img.freepik.com/premium-vector/chat-logo-with-robot-face_1124-277.jpg"
        allow-feedback="all">
        <df-messenger-chat-bubble
            expanded="true"
            chat-title="TLV Box"
            chat-subtitle="עוזרת אישית"
            allow-fullscreen="always">
        </df-messenger-chat-bubble>
    </df-messenger>
    <script>

        const accessTokenDiv = document.getElementById('jwt');
        const dfMessenger = document.querySelector('df-messenger');

        function receiveAccessToken(accessToken) {
            var token = jwt_decode(accessToken);
            dfMessenger.renderCustomText('שלום' + token.name)
            accessTokenDiv.innerText = accessToken;

            const expirationDiv = document.getElementById("expirationTime");
            var d = new Date(token.exp * 1000);
            expirationDiv.innerText = d
        }

        function expire() {

                webViewInterface = window.Android
                webViewInterface.refreshAccessToken();

        }

        function openCamera() {
            

            const mediaDevices = navigator.mediaDevices;
            if (!mediaDevices || !mediaDevices.getUserMedia) {
                alert("getUserMedia() not supported.");
                return;
            }

            mediaDevices.getUserMedia({video: true, 
                                        audio: false})
                        .then( (stream) => {
                            let video = document.getElementById("vid");
                            if ("srcObject" in video) {
                                video.srcObject = stream;
                            } else {
                                video.src = window.URL.createObjectURL(stream);
                            }
                            
                            video.addEventListener("loadedmetadata", () => {
                                video.play();
                            });
                        })
                        .catch(alert);

//                         Accessing the phone's front and rear cameras

// const constraints = {
//   video: {
//     width: { ... },
//     height: { ... },
//     facingMode: "environment"
//   },
// };

// videoStream.getTracks().forEach((track) => {
//   track.stop()
// })                        
            
// Taking screenshots

// // considering there is a
// // <canvas id="canvas"></canvas>
// // tag in the page
// const canvas = document.querySelector('#canvas')
// canvas.width = video.videoWidth
// canvas.height = video.videoHeight
// canvas.getContext('2d').drawImage(video, 0, 0)

// const img = document.createElement('img')
// img.src = canvas.toDataURL('image/png')
// screenshotsContainer.prepend(img)

        }

        if ("geolocation" in navigator) {
            alert('geolocation ia availabe')
            const watchID = navigator.geolocation.watchPosition((position) => {
                const location = `${position.coords.latitude}, ${position.coords.longitude}`
                console.log(location);
                const locationDiv = document.getElementById("location");
                locationDiv.innerText = location;
            }, () => {
                alert('No geolocation available')
            })
        }

        //dfMessenger.renderCustomText('שלום')

        window.addEventListener('df-messenger-loaded', function() {

            console.log('Messenger is now ready.');

            //const sendButton = document.shadowRoot.getElementById('send-icon-button');

            const payload = [
                {
                    "type": "info",
                    "title": "Info item title",
                    "subtitle": "Info item subtitle",
                    "image": {
                    "rawUrl": "https://example.com/images/logo.png"
                    },
                    "anchor": {
                    "href": "https://example.com",
                    "target": "_blank"
                    }
                }
            ];
            dfMessenger.renderCustomCard(payload);

            const queryParams = {
                parameters:{
                  "jwt": accessTokenDiv.innerText,
                  "User_Authorized": "True",
                  "userId": '313069486',
                  }
              };

            //dfMessenger.setQueryParameters(queryParams)
        });

        window.addEventListener('df-session-id-set', function(event) {
            console.log('Session set');
        });

        dfMessenger.addEventListener('df-chat-open-changed', function(event) {
            console.log(`Chat is ${event.detail.isOpen ? 'open' : 'closed'}`);
            const sendButton = document.getElementById('send-icon-button');
        });
        window.addEventListener('df-messenger-error', function (event) {
            console.log(event.detail.error)
        });
        window.addEventListener('df-request-sent', (event) => {
            console.log('Request', event.detail.data.requestBody);
        });
        window.addEventListener('df-response-received', (event) => {
            console.log(event.detail)
        })
        window.addEventListener('df-chip-clicked', (event) => {
            console.log(event)
        })
        window.addEventListener('df-user-input-entered', (event) => {
            console.log(event)

            const jwt = accessTokenDiv.innerText;
            var token = jwt_decode(jwt);

            const queryParams = {
                parameters:{
                  "jwt": jwt,
                  "userEmail": token["signInNamesInfo.emailAddress"],
                  "userName": token.name,
                  "userId": token["signInNames.citizenId"]
                  }
              };

            dfMessenger.setQueryParameters(queryParams)            
        })
        
    </script>
</body> 
  
</html>  